<html>
<body>
<script>
// initialize options
defaultOptions = {
    'overlay' : true,
    'wait' : 0
}

// clean up bad data in localStorage from version 1.1
if(localStorage.getItem('options') && localStorage.getItem('options') == '"options"')
    localStorage.removeItem('options');

if(o = localStorage.getItem('options'))
{
    options = JSON.parse(o);

    if(!options.overlay)
        options.overlay = defaultOptions.overlay;
    if(!options.wait)
        options.wait = defaultOptions.wait;
}
else
{
    localStorage.setItem('options', JSON.stringify(defaultOptions));        
}
// add new tab listener
chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) 
{
    if(tab.status == "complete")
    {
        if (localStorage.getItem(tab.url)) // if URL is in the list, send a request
            chrome.tabs.sendRequest(tab.id, options);
    }
});


// Respond to request to display "page action" icon from the content script
chrome.extension.onRequest.addListener(
    function(request, sender, sendResponse) 
    {
        if (request.showIcon) // if password field is present, present icon
            chrome.pageAction.show(sender.tab.id);
    }
);


// function to save page to localStorage.  called by the popup.
function savePage() 
{
    chrome.tabs.getSelected(null, function(tab)
    {
        localStorage.setItem(tab.url, tab.title);
        chrome.tabs.update(tab.id,{'url':tab.url});
    });
}

</script>
</body>
</html>